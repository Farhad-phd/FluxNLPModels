<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorial · FluxNLPModels.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/style.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="FluxNLPModels.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">FluxNLPModels.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Tutorial</a><ul class="internal"><li><a class="tocitem" href="#Setting-up"><span>Setting up</span></a></li><li><a class="tocitem" href="#Tools-associated-with-a-FluxNLPModel"><span>Tools associated with a FluxNLPModel</span></a></li><li><a class="tocitem" href="#Train-a-neural-network-with-JSOSolvers.R2"><span>Train a neural network with JSOSolvers.R2</span></a></li></ul></li><li><a class="tocitem" href="../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaSmoothOptimizers/FluxNLPModels.jl/blob/main/docs/src/tutorial.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="FluxNLPModels.jl-Tutorial"><a class="docs-heading-anchor" href="#FluxNLPModels.jl-Tutorial">FluxNLPModels.jl Tutorial</a><a id="FluxNLPModels.jl-Tutorial-1"></a><a class="docs-heading-anchor-permalink" href="#FluxNLPModels.jl-Tutorial" title="Permalink"></a></h1><h2 id="Setting-up"><a class="docs-heading-anchor" href="#Setting-up">Setting up</a><a id="Setting-up-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-up" title="Permalink"></a></h2><p>This step-by-step example assumes prior knowledge of <a href="https://julialang.org/">Julia</a> and <a href="https://github.com/FluxML/Flux.jl">Flux.jl</a>. See the <a href="https://julialang.org/learning/">Julia tutorial</a> and the <a href="https://fluxml.ai/Flux.jl/stable/models/quickstart/#man-quickstart">Flux.jl tutorial</a> for more details.</p><p>We have aligned this tutorial to <a href="https://github.com/FluxML/model-zoo/blob/master/vision/mlp_mnist/mlp_mnist.jl">MLP_MNIST</a> example and reused some of their functions.</p><h3 id="What-we-cover-in-this-tutorial"><a class="docs-heading-anchor" href="#What-we-cover-in-this-tutorial">What we cover in this tutorial</a><a id="What-we-cover-in-this-tutorial-1"></a><a class="docs-heading-anchor-permalink" href="#What-we-cover-in-this-tutorial" title="Permalink"></a></h3><p>We will cover the following:</p><ul><li>Define a Neural Network (NN) Model in Flux, <ul><li>Fully connected model</li></ul></li><li>Define or set the loss function</li><li>Data loading<ul><li>MNIST </li><li>Divide the data into train and test</li></ul></li><li>Define a method for calculating accuracy and loss</li><li>Transfer the NN model to FluxNLPModel </li><li>Using FluxNLPModels and access <ul><li>Gradient of current weight</li><li>Objective (or loss) evaluated at current weights </li></ul></li></ul><h3 id="Packages-needed"><a class="docs-heading-anchor" href="#Packages-needed">Packages needed</a><a id="Packages-needed-1"></a><a class="docs-heading-anchor-permalink" href="#Packages-needed" title="Permalink"></a></h3><pre><code class="language-julia hljs">using FluxNLPModels
using Flux, NLPModels
using Flux.Data: DataLoader
using Flux: onehotbatch, onecold, @epochs
using Flux.Losses: logitcrossentropy
using MLDatasets
using JSOSolvers</code></pre><h3 id="Setting-Neural-Network-(NN)-Model"><a class="docs-heading-anchor" href="#Setting-Neural-Network-(NN)-Model">Setting Neural Network (NN) Model</a><a id="Setting-Neural-Network-(NN)-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-Neural-Network-(NN)-Model" title="Permalink"></a></h3><p>First, a NN model needs to be define in Flux.jl. Our model is very simple: It consists of one &quot;hidden layer&quot; with 32 &quot;neurons&quot;, each connected to every input pixel. Each neuron has a sigmoid nonlinearity and is connected to every &quot;neuron&quot; in the output layer. Finally, softmax produces probabilities, i.e., positive numbers that add up to 1.</p><p>One can create a method that returns the model. This method can encapsulate the specific architecture and parameters of the model, making it easier to reuse and manage. It provides a convenient way to define and initialize the model when needed.</p><pre><code class="language-julia hljs">function build_model(; imgsize = (28, 28, 1), nclasses = 10)
  return Chain(Dense(prod(imgsize), 32, relu), Dense(32, nclasses))
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">build_model (generic function with 1 method)</code></pre><h3 id="Loss-function"><a class="docs-heading-anchor" href="#Loss-function">Loss function</a><a id="Loss-function-1"></a><a class="docs-heading-anchor-permalink" href="#Loss-function" title="Permalink"></a></h3><p>We can define any loss function that we need, here we use Flux build-in logitcrossentropy function. </p><pre><code class="language-julia hljs">## Loss function
const loss = Flux.logitcrossentropy</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">logitcrossentropy (generic function with 1 method)</code></pre><h3 id="Load-datasets-and-define-minibatch"><a class="docs-heading-anchor" href="#Load-datasets-and-define-minibatch">Load datasets and define minibatch</a><a id="Load-datasets-and-define-minibatch-1"></a><a class="docs-heading-anchor-permalink" href="#Load-datasets-and-define-minibatch" title="Permalink"></a></h3><p>In this section, we will cover the process of loading datasets and defining minibatches for training your model using Flux. Loading and preprocessing data is an essential step in machine learning, as it allows you to train your model on real-world examples.</p><p>We will specifically focus on loading the MNIST dataset. We will divide the data into training and testing sets, ensuring that we have separate data for model training and evaluation.</p><p>Additionally, we will define minibatches, which are subsets of the dataset that are used during the training process. Minibatches enable efficient training by processing a small batch of examples at a time, instead of the entire dataset. This technique helps in managing memory resources and improving convergence speed.</p><pre><code class="language-julia hljs">function getdata(bs)
  ENV[&quot;DATADEPS_ALWAYS_ACCEPT&quot;] = &quot;true&quot;

  # Loading Dataset
  xtrain, ytrain = MLDatasets.MNIST(Tx = Float32, split = :train)[:]
  xtest, ytest = MLDatasets.MNIST(Tx = Float32, split = :test)[:]

  # Reshape Data in order to flatten each image into a linear array
  xtrain = Flux.flatten(xtrain)
  xtest = Flux.flatten(xtest)

  # One-hot-encode the labels
  ytrain, ytest = onehotbatch(ytrain, 0:9), onehotbatch(ytest, 0:9)

  # Create DataLoaders (mini-batch iterators)
  train_loader = DataLoader((xtrain, ytrain), batchsize = bs, shuffle = true)
  test_loader = DataLoader((xtest, ytest), batchsize = bs)

  return train_loader, test_loader
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">getdata (generic function with 1 method)</code></pre><h3 id="Transfering-to-FluxNLPModels"><a class="docs-heading-anchor" href="#Transfering-to-FluxNLPModels">Transfering to FluxNLPModels</a><a id="Transfering-to-FluxNLPModels-1"></a><a class="docs-heading-anchor-permalink" href="#Transfering-to-FluxNLPModels" title="Permalink"></a></h3><pre><code class="language-julia hljs">  device = cpu
  train_loader, test_loader = getdata(128)

  ## Construct model
  model = build_model() |&gt; device

  # now we set the model to FluxNLPModel
  nlp = FluxNLPModel(model, train_loader, test_loader; loss_f = loss)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">FluxNLPModel{Float32, Vector{Float32}, Flux.Chain{Tuple{Flux.Dense{typeof(NNlib.relu), Matrix{Float32}, Vector{Float32}}, Flux.Dense{typeof(identity), Matrix{Float32}, Vector{Float32}}}}, typeof(Flux.Losses.logitcrossentropy)}
  Problem name: Generic
   All variables: ████████████████████ 25450  All constraints: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
            free: ████████████████████ 25450             free: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
           lower: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                lower: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
           upper: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                upper: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
         low/upp: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0              low/upp: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
           fixed: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                fixed: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
          infeas: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0               infeas: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
            nnzh: (  0.00% sparsity)   323863975          linear: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
                                                    nonlinear: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
                                                         nnzj: (------% sparsity)         

  Counters:
             obj: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                 grad: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                 cons: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
        cons_lin: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0             cons_nln: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                 jcon: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
           jgrad: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                  jac: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0              jac_lin: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
         jac_nln: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                jprod: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0            jprod_lin: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
       jprod_nln: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0               jtprod: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0           jtprod_lin: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
      jtprod_nln: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                 hess: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                hprod: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
           jhess: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0               jhprod: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
</code></pre><h2 id="Tools-associated-with-a-FluxNLPModel"><a class="docs-heading-anchor" href="#Tools-associated-with-a-FluxNLPModel">Tools associated with a FluxNLPModel</a><a id="Tools-associated-with-a-FluxNLPModel-1"></a><a class="docs-heading-anchor-permalink" href="#Tools-associated-with-a-FluxNLPModel" title="Permalink"></a></h2><p>The problem dimension <code>n</code>, where <code>w</code> ∈ ℝⁿ:</p><pre><code class="language-julia hljs">n = nlp.meta.nvar</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">25450</code></pre><h3 id="Get-the-current-network-weights:"><a class="docs-heading-anchor" href="#Get-the-current-network-weights:">Get the current network weights:</a><a id="Get-the-current-network-weights:-1"></a><a class="docs-heading-anchor-permalink" href="#Get-the-current-network-weights:" title="Permalink"></a></h3><pre><code class="language-julia hljs">w = nlp.w</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">25450-element Vector{Float32}:
 -0.03937941
  0.009516736
 -0.037224855
  0.076021604
 -0.027599048
 -0.019020274
  0.084764525
  0.010029609
  0.035320476
  0.07752332
  ⋮
  0.0
  0.0
  0.0
  0.0
  0.0
  0.0
  0.0
  0.0
  0.0</code></pre><h3 id="Evaluate-the-loss-function-(i.e.-the-objective-function)-at-w:"><a class="docs-heading-anchor" href="#Evaluate-the-loss-function-(i.e.-the-objective-function)-at-w:">Evaluate the loss function (i.e. the objective function) at <code>w</code>:</a><a id="Evaluate-the-loss-function-(i.e.-the-objective-function)-at-w:-1"></a><a class="docs-heading-anchor-permalink" href="#Evaluate-the-loss-function-(i.e.-the-objective-function)-at-w:" title="Permalink"></a></h3><pre><code class="language-julia hljs">using NLPModels
NLPModels.obj(nlp, w)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2.4465766f0</code></pre><p>The length of <code>w</code> must be <code>nlp.meta.nvar</code>.</p><h3 id="Evaluate-the-gradient-at-w:"><a class="docs-heading-anchor" href="#Evaluate-the-gradient-at-w:">Evaluate the gradient at <code>w</code>:</a><a id="Evaluate-the-gradient-at-w:-1"></a><a class="docs-heading-anchor-permalink" href="#Evaluate-the-gradient-at-w:" title="Permalink"></a></h3><pre><code class="language-julia hljs">g = similar(w)
NLPModels.grad!(nlp, w, g)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">25450-element Vector{Float32}:
  0.0
  0.0
  0.0
  0.0
  0.0
  0.0
  0.0
  0.0
  0.0
  0.0
  ⋮
 -0.03405908
 -0.03566672
  0.03660077
 -0.051751647
 -0.00036047335
  0.06504573
 -0.0023983982
 -0.026273206
  0.04727845</code></pre><h2 id="Train-a-neural-network-with-JSOSolvers.R2"><a class="docs-heading-anchor" href="#Train-a-neural-network-with-JSOSolvers.R2">Train a neural network with JSOSolvers.R2</a><a id="Train-a-neural-network-with-JSOSolvers.R2-1"></a><a class="docs-heading-anchor-permalink" href="#Train-a-neural-network-with-JSOSolvers.R2" title="Permalink"></a></h2><pre><code class="language-julia hljs">max_time = 60. # run at most 1min
callback = (nlp,
            solver,
            stats) -&gt; FluxNLPModels.minibatch_next_train!(nlp)

solver_stats = R2(nlp; callback, max_time)
test_accuracy = FluxNLPModels.accuracy(nlp) #check the accuracy</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.6872f0</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../reference/">Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Thursday 13 July 2023 14:11">Thursday 13 July 2023</span>. Using Julia version 1.9.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
